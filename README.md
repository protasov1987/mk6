# Трекер маршрутных карт ТСЗП (PHP + MySQL)

Монолитное веб‑приложение для управления технологическими картами, маршрутами и архивом, адаптированное под виртуальный хостинг Timeweb. Приложение работает на чистом PHP 8.2, хранит данные в MySQL 8.0 и не требует сторонних библиотек.

## Структура проекта
- `index.php` — основная страница с интерфейсом приложения, подключает `header.php` и `footer.php`.
- `app.js` — логика фронтенда, работа с API и UI.
- `style.css` — стили оформления.
- `config.php` — подключение к БД и базовая конфигурация.
- `helpers.php` — генерация штрихкодов, нормализация данных и вспомогательные функции.
- `storage.php` — загрузка и сохранение состояния приложения в таблице `app_state`.
- `api.php` — JSON API для загрузки и сохранения состояния.
- `files.php` — выдача прикреплённых файлов из базы.
- `database.sql` — SQL‑скрипт создания таблицы состояния приложения.
- `header.php` / `footer.php` — общий каркас страницы.

## Настройка базы данных (MySQL 8.0)
Используются переменные окружения с дефолтами под Timeweb:
```php
$db_host = getenv('DB_HOST') ?: 'localhost';
$db_name = getenv('DB_NAME') ?: 'cc226439_bd';
$db_user = getenv('DB_USER') ?: 'cc226439_bd';
$db_pass = getenv('DB_PASS') ?: '12345';
$db_port = getenv('DB_PORT') ?: '3306';
```

Создайте таблицу состояния одним из способов:
```bash
mysql -h <host> -u <user> -p<password> <db> < database.sql
```

Файл `database.sql` добавляет таблицу `app_state` с индексом по `id` и отметкой `updated_at`. Если данные и схема уже есть, примените миграцию один раз, чтобы добавить недостающие поля и индекс.

## Развёртывание на Timeweb
1. Загрузите все файлы в корень `public_html`.
2. Убедитесь, что на аккаунте включён PHP 8.2 и MySQL 8.0.
3. При необходимости задайте переменные окружения `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS`, `DB_PORT` через панель Timeweb.
4. Откройте в браузере `https://<ваш-домен>/index.php`.

## Работа приложения
- Фронтенд (HTML + CSS + JS) идентичен оригинальной версии: вкладки «Дашборд», «Тех. карты», «Трекер», «Архив», формы редактирования, история изменений, печать квитанций и сводок, управление файлами.
- Бэкенд хранит всё состояние (карты, операции, участки, вложения и логи) в таблице MySQL `app_state` в формате JSON. Запись с базовым набором данных создаётся автоматически только после первичного чтения, таблицу нужно подготовить миграцией.
- API: `GET /api.php` возвращает текущее состояние, `POST /api.php` принимает JSON `{ cards, ops, centers }` и сохраняет его.
- Вложения скачиваются по ссылке `files.php?id=<file_id>`.

## Тестирование
Для локальной проверки запустите встроенный PHP-сервер:
```bash
php -S localhost:8000
```
и откройте `http://localhost:8000/index.php`.
