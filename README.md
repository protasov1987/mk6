# Трекер маршрутных карт ТСЗП (PHP + MySQL)

Монолитное веб‑приложение для управления технологическими картами, маршрутами и архивом, адаптированное под виртуальный хостинг Timeweb. Приложение работает на чистом PHP 8.2, хранит данные в MySQL 8.0 и не требует сторонних библиотек.

## Структура проекта
- `index.php` — основная страница с интерфейсом приложения, подключает `header.php` и `footer.php`.
- `app.js` — логика фронтенда, работа с API и UI.
- `style.css` — стили оформления.
- `config.php` — подключение к БД и базовая конфигурация.
- `helpers.php` — генерация штрихкодов, нормализация данных и вспомогательные функции.
- `storage.php` — инициализация и сохранение состояния приложения в таблице MySQL.
- `api.php` — JSON API для загрузки и сохранения состояния.
- `files.php` — выдача прикреплённых файлов из базы.
- `database.sql` — SQL‑скрипт создания таблицы состояния приложения.
- `header.php` / `footer.php` — общий каркас страницы.

## Настройка базы данных (MySQL 8.0)
Используются переменные окружения с дефолтами под Timeweb:
```php
$db_host = getenv('DB_HOST') ?: 'localhost';
$db_name = getenv('DB_NAME') ?: 'cc226439_bd';
$db_user = getenv('DB_USER') ?: 'cc226439_bd';
$db_pass = getenv('DB_PASS') ?: '12345';
$db_port = getenv('DB_PORT') ?: '3306';
```

Создайте таблицу состояния одним из способов:
```bash
mysql -h <host> -u <user> -p<password> <db> < database.sql
```
Таблица будет создана автоматически при первом обращении к API, если прав достаточно.

## Развёртывание на Timeweb
1. Загрузите все файлы в корень `public_html`.
2. Убедитесь, что на аккаунте включён PHP 8.2 и MySQL 8.0.
3. При необходимости задайте переменные окружения `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS`, `DB_PORT` через панель Timeweb.
4. Откройте в браузере `https://<ваш-домен>/index.php`.

## Переменные окружения
Переопределяются через панель хостинга или локально перед запуском PHP:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS` — параметры подключения к MySQL.
- `DB_DSN` — полная строка DSN (перебивает параметры выше), пригодится при SQLite или нестандартных портах.
- `AUTH_TOKEN` — если задан, все обращения к API и HTML требуют передачи токена (см. раздел ниже).

## Миграция и инициализация базы
1. Создайте пустую базу MySQL 8.0.
2. Примените скрипт `database.sql` (создаёт таблицу `app_state` и строку с ID=1):
   ```bash
   mysql -h <host> -u <user> -p<password> <db> < database.sql
   ```
3. При первом запросе к API таблица также создаётся автоматически, если учётка имеет права `CREATE TABLE`.
4. Для локального теста допускается SQLite через `DB_DSN="sqlite:/полный/путь/app.db"` — таблица будет создана автоматически.

## Аутентификация и защита от CSRF
- Аутентификация: по умолчанию отключена. Если задан `AUTH_TOKEN`, нужно передавать его в одном из вариантов:
  - параметр `token` в URL или теле POST;
  - заголовок `Authorization: Bearer <token>`;
  - заголовок `X-Auth-Token: <token>`.
  Без токена сервер вернёт `401 Unauthorized`.
- CSRF: HTML-страница встраивает токен (`<meta name="csrf-token">`, `window.CSRF_TOKEN`). Для `POST /api.php` добавляйте заголовок `X-CSRF-Token` со значением токена из страницы; иначе вернётся `403 CSRF validation failed`.

## Запуск и проверка локально (чек-лист готовности)
1. Установите PHP 8.2+ и MySQL 8.0+.
2. Склонируйте проект и перейдите в каталог: `git clone ... && cd mk6`.
3. Создайте базу данных и прогоните миграцию из `database.sql` (либо подготовьте SQLite через `DB_DSN`).
4. Экспортируйте переменные окружения для подключения к БД (и `AUTH_TOKEN`, если нужно ограничить доступ).
5. Запустите встроенный сервер: `php -S localhost:8000`.
6. Откройте `http://localhost:8000/index.php`, убедитесь, что вкладки «Дашборд», «Тех. карты», «Трекер», «Архив» загружают данные без ошибок 401/403.
7. Выполните сценарии из раздела «Ручное тестирование»: по README можно пройти весь чек-лист без внешних знаний.

## Проверка в мобильном браузере
1. Запустите приложение локально (`php -S localhost:8000`).
2. Откройте DevTools в Chrome/Firefox → включите эмуляцию устройства (например, iPhone 12 или Pixel 5) с viewport 390×844.
3. Пройдитесь по вкладкам, убедитесь, что навигация кнопками остаётся доступной, таблицы/формы не уходят за экран, элементы кликабельны.
4. При `AUTH_TOKEN` передавайте токен в адресной строке (`?token=...`) или через расширение для заголовков, чтобы убедиться в отсутствии 401.

## Ручное тестирование
- **Валидация форм**: попытаться сохранить карту/операцию с пустыми обязательными полями (название, код операции), слишком длинными строками или отрицательными числами; ожидаем ошибку 400 от `POST /api.php` с сообщением о поле.
- **Коллизии версий**: открыть одну карту в двух вкладках, изменить и сохранить в обеих; после повторной загрузки убедиться, что сервер сохраняет `createdAt` и `initialSnapshot`, а операции/логи не теряются (merge по `id`).
- **Загрузка файлов**: добавить вложение (до ~2 МБ, base64), проверить, что файл появляется в списке и скачивается по `files.php?id=<id>`; попробовать загрузить файл больше лимита/некорректный base64 — ожидаем ошибку 400.

## Работа приложения
- Фронтенд (HTML + CSS + JS) идентичен оригинальной версии: вкладки «Дашборд», «Тех. карты», «Трекер», «Архив», формы редактирования, история изменений, печать квитанций и сводок, управление файлами.
- Бэкенд хранит всё состояние (карты, операции, участки, вложения и логи) в таблице MySQL `app_state` в формате JSON. Первичный набор данных создаётся автоматически.
- API: `GET /api.php` возвращает текущее состояние, `POST /api.php` принимает JSON `{ cards, ops, centers }` и сохраняет его.
- Вложения скачиваются по ссылке `files.php?id=<file_id>`.

## Тестирование
Для локальной проверки запустите встроенный PHP-сервер:
```bash
php -S localhost:8000
```
и откройте `http://localhost:8000/index.php`.
